<!DOCTYPE html>
<html>

  <head>
    <title>Samee</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="./stylesheets/main.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.css">

    <script src="./javascripts/jquery-1.12.4.min.js"></script>
    <script src="./javascripts/sb-1.3.5.js"></script>
    <script src="./javascripts/sb-admin-0.1.4.js"></script>
    <script src="./javascripts/config.js"></script>
    <script src="./javascripts/robot.js"></script>
    <script src="./javascripts/gamepad.js"></script>
    <script src="./javascripts/connect_message.js"></script>
  </head>

  <body class="robot_interface">

    <div id="connecting-page">
      <div id="connecting-message"></div>
    </div>

    <div id="main">
      <div id="wrapper">
        
        <div class="btnGrp">
          <a href="#" id="start-camera" class="cameracontrol fa fa-bolt " title="start camera"></a>
          <a href="#" id="stop-camera" class="cameracontrol fa fa-bomb" title="stop camera"></a>
          <a href="#" id="take-snapshot" class="cameracontrol fa fa-camera " title="take snapshot"></a>
          <a href="#" id="start-recording" class="cameracontrol fa fa-circle " title="start recording"></a>
          <a href="#" id="stop-recording" class="cameracontrol fa fa-square" title="stop recording"></a>
          <a href="#" id="view-media" class="cameracontrol fa fa-bank" title="view media"></a>
        </div>

        <img src="./images/bg.png" class="streaming" id="robot-camera">
          
        <div id="control-panel-div" style="border: 1px black solid;">
          <select id="control-panel-select" style="float:right;">
            <option value="keyboard">Keyboard</option>
            <option value="gamepad">Gamepad</option>
            <option value="mouse">Mouse</option>
            <option value="random">Random Movement</option>
            <option value="preferences">Preferences</option>
          </select>
          <div id="chevron-control-panel" class="control-panel">     
            <a href="#" id="forward" class="control fa fa-chevron-up fa-2x"></a>     
            <a href="#" id="left" class="control fa fa-chevron-left fa-2x"></a>
            <a href="#" id="slight-left" class="control fa fa-chevron-left fa-1x"></a>  
            <a href="#" id="slight-right" class="control fa fa-chevron-right fa-1x"></a>    
            <a href="#" id="right" class="control fa fa-chevron-right fa-2x"></a>
            <a href="#" id="back" class="control fa fa-chevron-down fa-2x"></a>
            <a href="#" id="slight-forward" class="control fa fa-chevron-up fa-1x"></a>  
            <a href="#" id="slight-back" class="control fa fa-chevron-down fa-1x"></a>
          </div>
          <div id="keyboard-control-panel" class="control-panel"></div>
          <div id="gamepad-control-panel" class="control-panel"></div>  
          <div id="random-control-panel" class="control-panel"></div>
          <div id="preferences-control-panel" class="control-panel"></div> 
        </div>
        <br><br>
        <div id="motor-display" style="color:black;"></div>
      </div>
    </div>

    <script>

      // GLOBAL VARS
      var ip_address = CONFIG.sshHost;
      var control_port = "80";
      var stream_port = CONFIG.streamPort;

      var robot = new Robot();
      var gamepad = new Gamepad();
      var message = new ConnectMessage($("#connecting-message"));
      var stream_url = "http://" + ip_address + ":" + stream_port + "/?action=stream";

      // COMMANDS
     // message.on();
    /*  robot.connect(function(response) {
        if (response.status == "success") {
          console.log("Connected to robot.");
          message.off();
          initializeMain();     
        } else {
          console.log("Error: " + response.status);
          message.error("Could not connect.");
        }
      });*/

      //robot.connect();
      initializeMain();

      // INITIALIZATION
      function initializeMain() {
        console.log("running initialize main");
        $("#connecting-page").hide();
        $("#main").fadeIn(2000);

        // if the stream is on, load it into the robot camera
        $("<img>").load(function() {
          $("#robot-camera").attr('src', stream_url);
        }).attr('src', stream_url);

        initializeGamepad();
      }

      // CONTROL PANEL SWITCHES
      $("#control-panel-select").change(function(){
        $(".control-panel").hide();
        switch($(this).val()) {
          case "keyboard":
            $("#keyboard-control-panel").show();
            break;
          case "gamepad":
            $("#gamepad-control-panel").show();
            break;
          case "mouse":
            $("#chevron-control-panel").show();
            break;
          case "random":
            $("#random-control-panel").show();
            break;
          case "preferences":
            $("#preferences-control-panel").show()
            break;
        }

        console.log("changing panels");
        console.log($(this).val());
      });

     // $("#control-panel-select").trigger('change');

      // CONNECT BUTTON
      $("#connect-to-samee").click(function(){
        robot.connect();
      });

      // CAMERA CONTROLS
      $("#start-camera").click(function() {
        console.log("sending start request");
        $.get('/start_camera', function(response) {
          console.log(response);  
          setTimeout(function() {
            $("#robot-camera").attr('src', stream_url);
          }, 1000);
        });
      });

      $("#stop-camera").click(function() {
        console.log("sending stop request");
        $.get('/stop_camera', function(response) {
          console.log(response);
          $("#robot-camera").attr('src', '');
          $("#robot-camera").attr('src', '/images/bg.png');
        });
      });

      $("#show-stream").click(function() {
        $("#robot-camera").attr('src', stream_url);
      });
/*
      $("#take-snapshot").click(function() {
        console.log("snapshot request");
        $.get('/take_snapshot', function(response) {
          console.log(response);
          $("#robot-camera").hide();
          $("#robot-camera").fadeIn(100);
        });
      });

      $("#start-recording").click(function() {
        console.log("clicked start recording");
        $.get('/start_recording', function(response) {
          console.log(response);
          $(this).removeClass('fa-circle-thin');
          $(this).addClass('fa-circle recording');
        });
      });

      $("#stop-recording").click(function() {
        console.log("clicked stop recording");
        $.get('/stop_recording', function(response) {
          console.log(response);
          $('#start-recording').removeClass('fa-circle recording');
          $('#start-recording').addClass('fa-circle-thin');
        });
      });
*/
      // RANDOM MOVEMENT
      $("#random-start").click(function() {
        console.log("starting random motion");
        shuffler.start();
      });

      $("#random-stop").click(function() {
        console.log("stopping random motion");
        shuffler.stop();
      });

      var shuffler = (function() {
        var cycle_time = 5000;
        var min_turn_time = 300;
        var max_turn_time = 1000;
        var straight_speed = 100;
        var turn_speed = 125;

        var timer;

        return {
          start: function() {

            timer = setInterval(function() {

              robot.update(straight_speed, straight_speed);

              var turn_time = Math.floor(Math.random() * (max_turn_time - min_turn_time)) + (cycle_time - max_turn_time);
              setTimeout(function() {
                var mult = Math.floor((Math.random() * 2)) == 0 ? 1 : -1;
                robot.update(mult * turn_speed, -1 * mult * turn_speed);
              }, turn_time);

            }, cycle_time);

          },

          stop: function() {
            clearInterval(timer);
          }
        }
      })();

      // CHEVRON CONTROLS
      var FBR = 1.0;     // front-back ratio
      var SSR = 1.0;     // spin-speed ratio

     /* var LMR = 0.9875;   // left motor reduction (forward)
      var RMR = 1.0;      // right motor reduction (back)

      var BLMR = 1.0;     // back left motor reduction
      var BRMR = 0.89;    // back right motor reduction*/

      var LMR = 1.0;
      var RMR = 1.0;
      var BLMR = 1.0;
      var BRMR = 1.0;

      $(".control").mousedown(function() {
        switch($(this)[0].id) {
          case "forward":
            robot.update(255 * FBR * LMR, 255 * FBR * RMR);
            break;
          case "left":
            robot.update(-255 * SSR, 255 * SSR);
            break; 
          case "right":
            robot.update(255 * SSR, -255 * SSR);
            break;
          case "back":
            robot.update(-255 * FBR * BLMR, -255 * FBR * BRMR);
            break;
        /*  case "slight-forward":
            robot.update(255 * FBR * LMR, 255 * FBR * RMR, 500);
            break;
            case "slight-left":
            robot.update(-255 * SSR, 255 * SSR, 500);
            break;
            case "slight-right":
            robot.update(255 * SSR, -255 * SSR, 500);
            break;
            case "slight-back":
            robot.update(-255 * FBR * BLMR, -255 * FBR * BRMR, 500);
            break;*/
        }
      });

      $(".control").mouseup(function(e) {
        e.stopPropagation();
        var id = $(this)[0].id;
        if (id == "forward" || id == "back" || id == "left" || id == "right") {
          robot.update(0, 0);
        }
      });

      // GAMEPAD CONTROLS
      function initializeGamepad() {
        for (var i = 0; i < 17; i++) {
          $('<div class="c-button">').html(i).appendTo($("#button-panel"));
        }
      
        gamepad.addAxisHandler(handleAxes);
        gamepad.addButtonHandler(handleButtons);
        gamepad.on();
      }

      function drawReticules(axes) {
        var multX = $(".axis-canvas.one").width() / 2.0;
        var multY = $(".axis-canvas.one").height() / 2.0;
        var x1 = multX * (axes[0] + 1);
        var y1 = multY * (axes[1] + 1);
        var x2 = multX * (axes[2] + 1);
        var y2 = multY * (axes[3] + 1);

        $(".reticule.one").css('top', (y1 - 5) + 'px').css('left', (x1 - 5) + 'px');
        $(".reticule.two").css('top', (y2 - 5) + 'px').css('left', (x2 - 5) + 'px');
      }

      function radius(x, y) {
        return Math.sqrt(x * x + y * y);
      }

      function handleAxes(axes) {
        // update the reticules
      //  drawReticules(axes);

        // get motor speeds based on the position of the axes
        var lmotor, rmotor, mult;
        if (Math.abs(axes[2]) > 0.1) {

          lmotor = axes[2] * SSR;
          rmotor = -1 * axes[2] * SSR;

        } else if (Math.abs(axes[0]) > 0.1 || Math.abs(axes[1]) > 0.1) {

       /* var left = -1 * axes[1];
          var left_mult = Math.min(1, 1 + 0.5 * axes[0]);

          var right = -1 * axes[1];
          var right_mult = Math.min(1, 1 - 0.5 * axes[0]);

          lmotor = left * left_mult;
          rmotor = right * right_mult;*/

          if (axes[0] <= 0) {
            lmotor = -1 * axes[1];

            mult = axes[1] < 0 ? 1 : -1;
            rmotor = mult * Math.min(1.0, radius(axes[0], axes[1]));
          } else {
            mult = axes[1] < 0 ? 1 : -1;
            lmotor = mult * Math.min(1.0, radius(axes[0], axes[1]));

            rmotor = -1 * axes[1];
          }

        } else {

          lmotor = 0;
          rmotor = 0;

        }

        // display the motor speeds
        $("#motor-display").html(
          "L motor: " + (lmotor * 255).toFixed(0) + '<br>' + 
          "R motor: " + (rmotor * 255).toFixed(0)
        );

        // send the speeds to the robot
        robot.update(lmotor * 255, rmotor * 255);

      }
      
      function handleButtons(buttons) {
        for (var i = 0; i < buttons.length; i++) {
          var button = buttons[i];
          var pressed = button == 1.0;
          if (typeof(button) == "object") 
            pressed = button.pressed;

          if (pressed)  
            $(".c-button").eq(i).css('background-color', '#00c5ff'); 
          else
            $(".c-button").eq(i).css('background-color', 'transparent'); 
        }
      }


      // KEYBOARD CONTROLS
      var key_detector = (function () {
        var map = []; 

        onkeydown = onkeyup = function(e) {
          e = e || event; // to deal with IE
          map[e.keyCode] = (e.type == 'keydown');
          updateRobot();
       //   console.log("map = ", map);
        }

        // a = 65 d = 68
        // s = 83  w = 87
        // left arrow = 37
        // right arrow = 39

        function updateRobot() {
          var lmotor = 0, rmotor = 0;

          if (map[37]) {
            lmotor = -255;
            rmotor = 255;
          } else if (map[39]) {
            lmotor = 255;
            rmotor = -255;
          } else if (map[65] && map[87]) {
            lmotor = 150;
            rmotor = 255;
          } else if (map[68] && map[87]) {
            lmotor = 255;
            rmotor = 150;
          } else if (map[65]) {
            lmotor = 0;
            rmotor = 255;
          } else if (map[68]) {
            lmotor = 255;
            rmotor = 0;
          } else if (map[87]) {
            lmotor = 255;
            rmotor = 255;
          } else if (map[83]) {
            lmotor = -255;
            rmotor = -255;
          } 

         // display the motor speeds
          $("#motor-display").html(
            "L motor: " + lmotor + '<br>' + 
            "R motor: " + rmotor
          );
             
          robot.update(lmotor, rmotor);
        }

      })();

    </script>
    
    <footer class="footer">

    </footer>
  
  </body>

</html>
